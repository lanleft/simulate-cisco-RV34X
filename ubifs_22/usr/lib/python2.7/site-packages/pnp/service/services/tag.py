################################################################################
# Copyright (c) 2015-17 by Cisco Systems, Inc.
# All rights reserved.
#
# Author: Charuta Dusane <cdusane@cisco.com>
################################################################################
"""PnP Service: Tag"""
from pnp.infra.system.cdp import CDP
from pnp.service.api.pnp_service import PnPService


class TagInfoError(Exception):
    """Tag Info Error (inherits from Exception)"""
    pass


class Tag(PnPService):
    """PnP Service: Tag"""
    _request_type = None

    def run(self):
        """Get the result after process the request.
        Generates the Tag-Info Work-Response."""
        self._request_type = self.request['tag']
        result = False
        if self._request_type:
            persist = self._request_type.get('set', False)
            try:
                result = self._set_cdp_app_tag(self._request_type['tagValue'],
                                               persist)
            except TagInfoError as err:
                self.logger.debug(err)
        else:
            err_msg = "Malformed request"
            self.logger.error(err_msg)
            self.set_error_info(code='REQ', msg=err_msg)
        self.success = int(result)

    def _set_cdp_app_tag(self, device_tag, persist):
        """Populates CDP neighbor response.

                Modifies: self.response.

                Returns:
                    String: Device tag.

                """
        try:
            if device_tag:
                return CDP.set_cdp_app_tag(device_tag, persist)
        except Exception as err:
            err_msg = "CDP info request failure while setting location tag"
            self.logger.error(err_msg)
            self.set_error_info(code='INTERNAL', msg=err_msg)
            raise TagInfoError(err)
        return True
